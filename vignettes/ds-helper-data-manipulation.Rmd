---
title: "dsHelper Data Manipuation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dsUpload}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introducation
dsHelper contain a number of client-side functions designed to simplify data 
manipulation and analysis using DataSHIELD. Currently dsHelper functions can
be broadly categorised as:

- Functions to manipulate data
- Functions to view summaries of data
- Functions to help analyse data
- Functions to faciliate mixed-effect/trajectory analysis

This vignette demonstrates the data manipulation functions.

```{r}
library(dsHelper)
library(dsBaseClient)
library(DSI)
library(DSMolgenisArmadillo)
```

# Data: simulated data based on LifeCycle variables
To explore data manipulation using dsHelper we will use fake data held on an
armadillo server. We will use data for two cohorts: ALSPAC and GECKO.

If you are unsure how to log in, please consult the DataSHIELD vignette:
[link] 

```{r}
token <- armadillo.get_token("https://armadillo.test.molgenis.org")

builder <- DSI::newDSLoginBuilder()

#builder$append(
#  server = "alspac",
#  url = "https://armadillo.test.molgenis.org",
#  table = "alspac/2_1-core-1_0/nonrep",
#  token = token,
#  driver = "ArmadilloDriver")

builder$append(
  server = "gecko",
  url = "https://armadillo.test.molgenis.org",
  table = "gecko/2_1_core_1_1/non_rep",
  token = token,
  driver = "ArmadilloDriver")

logindata <- builder$build()

conns <- DSI::datashield.login(
  logins = logindata, 
  assign = TRUE)
```

We will now assign a small subset of variables to two tables: non-repeated 
measures and repeated measures. 

```{r}
datashield.assign(
  symbol = "nonrep", 
  value = "gecko/2_1_core_1_1/non_rep", 
  variables = c(
    "child_id", "ethn3_m", "sex", "ga_bj", "height_m", "ivf", "smk_cig_p", 
    "ga_us", "birth_month", "prepreg_cig", "preg_ht", "preg_smk", "preg_alc"), 
  conns = conns)

datashield.assign(
  symbol = "monthrep", 
  value = "gecko/2_1_core_1_1/monthly_rep", 
  variables = c("child_id", "height_", "height_age", "age_years"), 
  conns = conns)   
```

Let's have a look at the data:
```{r}
ds.colnames("nonrep")
ds.colnames("monthrep")
```

# Rename variables with dh.renameVars()
dh.renameVars allows you to change the names of one or more variables within a 
dataframe. For example, we can rename the variables "child_id", and "ethn3_m"
with simpler names:
```{r}
dh.renameVars(
  df = "nonrep",
  current_names = c("smk_cig_p", "ethn3_m"), 
  new_names = c("pat_smoke", "ethnicity")
  )

ds.colnames("nonrep")
```

# Removing columns with dh.dropCols()
dh.dropCols allows you to remove columns from a dataframe. The argument "type"
allows you to specify whether to remove or to keep the provided variables. For
example, we can remove the columns "ga_us" and "birth_month":
```{r}
dh.dropCols(
  df = "nonrep", 
  vars = c("ga_us", "birth_month"), 
  type = "remove")

ds.colnames("nonrep")
```

Alternatively, we can just to keep certain columns and remove everything else.
In this example we keep the columns "sex", "height_m" and "ivf":
```{r}
dh.dropCols(
  df = "nonrep", 
  vars = c("child_id", "sex", "height_m", "ivf", "prepreg_cig", "preg_ht", 
    "preg_smk", "preg_alc"), 
  type = "keep")

ds.colnames("nonrep")
```

# Deriving a single outcome variable from repeated measures data using dh.makeOutcome()
A common scenario is where you have repeat measurements of a variable at 
different times, but you want to create a variable using only some of these
observations within a certain age range.

For example, you may have a dataset with repeat measurments of height between
ages 2-10. However, you want to create a new variable which is height between
ages 4-6. This is quite a long process in datashield, as it involves creating
a number of subsets. It is also necessary to deal with situations where a 
subject has >1 observation within the specified period.

In this example, we two variables indicating child height measured between (i)
ages 4-6 and (ii) ages 7-10. Where children have more than one observation in 
either window, we chose to take the earliest measurement. This behaviour is
controlled by the argument "mult_action". You can also choose to take (i) the 
latest variable, or (ii) the variable closest to a particular time point.
Finally, within each band we choose to take values >= to the lowest band, and 
< the highest band. This behaviour is controlled by the argument "band_action".
See ?dh.makeOutcome for more information on the available arguments.

In this example it runs quite quickly, however if you are using many cohorts
with large datasets it can take a considerable amount of time (30 - 60 min).

```{r}
dh.makeOutcome(
  df = "monthrep",
  outcome = "height_",
  age_var = "age_years", 
  bands = c(4, 6, 7, 10), 
  mult_action = "earliest",
  band_action = "ge_l", 
  id_var = "child_id", 
  df_name = "height_data"
  )

ds.colnames("height_data")
```

The created dataset contains 5 variables: the id variable, two variables
giving the height value within the specified bands (height_.6, height_.10) and
two variables giving the age of measurement for these height variables (age.6,
age.10). We can check age.6 and age.10 to make sure the mean ages correspond
to the bands we specified:
```{r}
ds.summary("height_data$age.6")
ds.summary("height_data$age.10")
```

We can then use ds.merge to join this dataframe back with our other nonrepeated
data:
```{r}
ds.merge(
  x.name = "nonrep", 
  y.name = "height_data", 
  by.x = "child_id", 
  by.y = "child_id", 
  all.x = TRUE, 
  newobj = "nonrep"
  )

ds.colnames("nonrep")
```


# Creating a dataset for analysis using dh.subjHasData()
Before starting analysis you often want to restrict the dataset to subjects
meeting certain criteria. In the first example, we create a variable indicating
whether subjects have complete data on the variables sex, ivf & preg_smk:
```{r}
dh.defineCases(
  df = "nonrep", 
  vars = c("sex", "ivf", "preg_smk"), 
  type = "all")

ds.summary("dc_all_data")
``` 

SIDO TO MAKE BETTER MISSING DATA

We can also check whether subjects have available data on *any* of a set of 
variables:
```{r}
dh.defineCases(
  df = "nonrep", 
  vars = c("sex", "ivf", "preg_smk"), 
  type = "any")

ds.table("dc_any_data")
``` 


, for example subjects with data on

 the exposure
and outcome. 


"dh.anyData"          
"dh.localProxy"
"dh.findVarsIndex"
"dh.tidyEnv"


"dh.classDiscrepancy" 
"dh.getStats"
"dh.lmTab"
"dh.getAnonPlotData"  

"dh.metaManual"

"dh.lmeMultPoly"
"dh.makeAgePolys"
"dh.makeLmerForm"     


[13]               
[16] 

